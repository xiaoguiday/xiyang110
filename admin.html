<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>WSTunnel Admin</title>
<!-- ...你的原CSS保持不变... -->
</head>
<body>
<div class="container">
<nav class="navbar">
    <!-- ...导航保持不变... -->
</nav>
<div class="status-bar">
    <!-- ...状态栏保持不变... -->
</div>
<main id="content-area"></main>
</div>
<script>
const gid = id => document.getElementById(id); const contentArea = gid('content-area');
let appState = { devices: {}, usage: {}, settings: null, connections: [], logs: [] };
// ...其它函数保持不变...

function generateKey() {
    const array = new Uint8Array(16);
    window.crypto.getRandomValues(array);
    const b64 = btoa(String.fromCharCode.apply(null, array));
    gid("sec_ws_key").value = b64;
}

function renderDevicePage() {
    // ...表单和表头加 sec_ws_key 和 max_sessions 字段...
    // 见前面合并方案
}

function fillExisting() { 
    const s = gid("existing_user"), [id, exp, lim, sec_ws_key, max_sessions] = s.value.split('|'); 
    if (id) { 
        gid("device_id").value = id; 
        gid("expiry").value = exp; 
        gid("limit_gb").value = lim; 
        gid("sec_ws_key").value = sec_ws_key||""; 
        gid("max_sessions").value = max_sessions||"1";
    } 
}

async function addID() { 
    const d = { 
        device_id: gid("device_id").value.trim(), 
        expiry: gid("expiry").value.trim(), 
        limit_gb: gid("limit_gb").value.trim() || "0",
        sec_ws_key: gid("sec_ws_key").value.trim(),
        max_sessions: parseInt(gid("max_sessions").value)||1
    }; 
    if (!d.device_id || !d.expiry) return alert("ID和有效期不能为空"); 
    if (!d.sec_ws_key) return alert("Sec-WebSocket-Key不能为空，请生成或填写！");
    if (d.max_sessions<0||d.max_sessions>5) return alert("最大多点登录数必须在0~5之间");
    const r = await post("/device/add", d); 
    if (r && r.status === 'ok') { 
        alert(r.message); 
        const [devs, usage] = await Promise.all([get('/api/devices'), get('/api/device_usage')]); 
        appState.devices = devs || appState.devices; 
        appState.usage = usage || appState.usage; 
        renderDevicePage(); 
    } 
}

async function updateAccount() { 
    const d = { old_user: gid("old_user").value, old_pass: gid("old_pass").value, new_user: gid("new_user").value, new_pass: gid("new_pass").value }; 
    if (Object.values(d).some(v => !v)) return alert("请完整填写"); 
    const r = await post("/account/update", d); 
    if (r) {
        alert(r.message);
        if (r.status === "ok") {
            logout();
        }
    }
}

function logout() { 
    fetch("/logout", { method: 'POST' }).finally(() => {
        window.location.href = "/"; // 强制刷新到首页
    });
}
</script>
</body>
</html>
