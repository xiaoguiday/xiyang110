<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>WSTunnel 系统管理</title>
    <style>
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";background:#f4f7fb;margin:0;font-size:15px}
        .container{max-width:1400px;margin:0 auto;padding:0 18px}
        .card{background:white;border-radius:8px;padding:18px;margin-top:12px;box-shadow:0 4px 14px rgba(20,30,60,0.06)}
        table{width:100%;border-collapse:collapse;font-size:14px}th{white-space:nowrap}thead th{position:sticky;top:0;background:#fff;padding:10px 12px;text-align:left;border-bottom:2px solid #eef2f7;font-weight:700}th,td{padding:10px 12px;border-bottom:1px solid #f1f5f9;word-wrap:break-word;}tr:last-child td {border-bottom: none;}.table-container,.device-list-container{overflow:auto;border-radius:8px;border:1px solid #e6eef8;margin-top:8px}.table-container{max-height:calc(100vh - 400px)}.device-list-container{max-height:360px}.btn{border:0;padding:8px 12px;border-radius:6px;cursor:pointer;font-weight:700;color:white;transition:opacity .2s}.btn:hover{opacity:0.85}.btn.primary{background:#2563eb}.btn.secondary{background:#10b981}.btn.danger{background:#dc2626}.btn.info{background:#0ea5e9}.btn.warning{background:#f59e0b}.status-pill{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:700;font-size:13px}.status-active{background:#e6ffed;color:#065f46}.status-down{background:#fff2f2;color:#991b1b}.status-handshake{background:#fffbeb;color:#b45309}.navbar{display:flex;gap:8px;align-items:center;padding:8px 0;flex-wrap:wrap;border-bottom: 1px solid #e2e8f0;}.navbar a{padding:8px 12px;border-radius:8px;text-decoration:none;font-weight:700;color:#0f172a;transition:background-color .2s, color .2s}.navbar a.active{background:#eef2ff; color:#2563eb;}.navbar a:not(.active):hover{background-color:#f8fafc;}.form-row{display:flex;gap:10px;align-items:center;margin-top:8px;flex-wrap:wrap}.form-row label{min-width:180px;font-weight:600}input[type="text"],input[type="password"],input[type="number"],select{height:32px;font-size:14px;padding:4px 8px;border:1px solid #e2e8f0;border-radius:6px;box-sizing:border-box}.status-bar{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;padding:12px 0}.status-card{background:#fff;border-radius:8px;padding:12px 16px;box-shadow:0 4px 12px rgba(20,30,60,0.05);border:1px solid #eef2f7;display:flex;flex-direction:column;gap:4px}.status-card span{font-size:14px;color:#64748b}.status-card strong{font-size:16px;color:#0f172a;font-weight:600}.status-card small{font-size:12px;color:#94a3b8}.settings-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:18px;margin-top:12px}.settings-group{border:1px solid #eef2f7;border-radius:8px;padding:12px 16px}.settings-group h3{margin-top:0;font-size:16px;border-bottom:1px solid #eef2f7;padding-bottom:10px;margin-bottom:16px}.settings-group .form-row{margin-top:12px}.settings-group .form-row label{min-width:140px;text-align:right;font-weight:normal;color:#334155}.settings-group .form-row input[type=text]{flex-grow:1}.settings-group .form-row.full-width{flex-direction:column;align-items:flex-start}.settings-group .form-row.full-width label{text-align:left;margin-bottom:5px;min-width:auto}.settings-group .form-row.full-width input{width:100%;box-sizing:border-box}
        .toggle-switch{position:relative;display:inline-block;width:50px;height:28px}
        .toggle-switch input{opacity:0;width:0;height:0}
        .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.4s;border-radius:28px}
        .slider:before{position:absolute;content:"";height:20px;width:20px;left:4px;bottom:4px;background-color:white;transition:.4s;border-radius:50%}
        input:checked+.slider{background-color:#2563eb}
        input:checked+.slider:before{transform:translateX(22px)}
    </style>
</head>
<body>
<div class="container">
    <nav class="navbar">
        <a href="#/status">连接状态</a>
        <a href="#/device">设备管理</a>
        <a href="#/account">账号设置</a>
        <a href="#/settings">系统设置</a>
        <a href="#/logs">系统日志</a>
        <a style="margin-left:auto;background:#ff6b6b;color:#fff;border-radius:6px;padding:8px 12px;text-decoration:none" href="#" onclick="logout()">退出</a>
    </nav>
    <div class="status-bar">
        <div class="status-card"><span>登录用户</span><strong id="current-user">...</strong></div>
        <div class="status-card"><span>活跃连接</span><strong id="active-connections">...</strong></div>
        <div class="status-card"><span>总上传</span><strong id="global-sent">...</strong></div>
        <div class="status-card"><span>总下载</span><strong id="global-received">...</strong></div>
        <div class="status-card"><span>运行时长</span><strong id="server-uptime">...</strong></div>
        <div class="status-card"><span>CPU <small>(核心)</small></span><strong><span id="cpu-usage">...</span> (<span id="cpu-cores">...</span>)</strong></div>
        <div class="status-card"><span>内存使用</span><strong id="mem-usage">...</strong></div>
    </div>
    <main id="content-area"></main>
</div>

<script>
    const gid = id => document.getElementById(id); const contentArea = gid('content-area');
    let appState = { devices: {}, usage: {}, settings: null, connections: [], logs: [], currentUser: '' };
    let refreshInterval;

    async function apiRequest(url, options = {}) {
        try {
            const response = await fetch(url, options);
            if (response.status === 401) {
                if (url !== '/logout') { 
                    window.location.reload();
                }
                throw new Error(`Unauthorized`);
            }
            if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
            if (url === '/logout') return {status: 'ok'}; 
            return await response.json();
        } catch (error) {
            console.error(`API request to ${url} failed:`, error);
            if (options.method === 'POST' && url !=='/logout') alert(`操作失败: ${error.message}`);
            return null;
        }
    }

    const get = (url) => apiRequest(url);
    const post = (url, data) => apiRequest(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
    function formatBytesJS(b, d = 2) { if (b <= 0) return "0 B"; const k = 1024, s = ["B", "KB", "MB", "GB", "TB"], i = Math.floor(Math.log(b) / Math.log(k)); return parseFloat((b / Math.pow(k, i)).toFixed(d)) + " " + s[i]; }
    
    function renderConnectionsTable() { const t = gid('connections-body'); if (!t) return; let h = ''; if (appState.connections.length === 0) { h = '<tr><td colspan="11" style="text-align:center;">暂无连接</td></tr>'; } else { const statusClasses = { '活跃': 'active', '断开': 'down', '握手': 'handshake' }; appState.connections.forEach(c => { let b = c.status === '活跃' ? `<button class="btn danger btn-sm" onclick="kickUser('${c.conn_key}', '${c.device_id}')">踢掉</button>` : `<button class="btn info btn-sm" onclick="clearConnection('${c.conn_key}')">清除</button>`; const statusClass = statusClasses[c.status] || 'down'; h += `<tr><td>${c.device_id}</td><td><span class="status-pill status-${statusClass}">${c.status}</span></td><td>${c.sent_str}</td><td>${c.rcvd_str}</td><td>${c.speed_str}</td><td>${c.remaining_str}</td><td>${c.expiry}</td><td>${c.ip}</td><td>${c.first_conn}</td><td>${c.last_active}</td><td>${b}</td></tr>`; }); } t.innerHTML = h; filterTable(); }
    function renderStatusPage() { contentArea.innerHTML = `<div class="card"><h2>连接状态</h2><div class="form-row"><input id="search_input" type="text" placeholder="模糊搜索..." onkeyup="filterTable()"></div><div class="table-container"><table id="connections"><thead><tr><th>客户端ID</th><th>状态</th><th>上传</th><th>下载</th><th>当前速率</th><th>剩余流量</th><th>有效期</th><th>IP地址</th><th>首次连接</th><th>上次活动</th><th>操作</th></tr></thead><tbody id="connections-body"></tbody></table></div></div>`; renderConnectionsTable(); }
    
    function renderDevicePage() {
        if (!appState.settings) { contentArea.innerHTML = `<div class="card">正在加载初始数据...</div>`; return; }
        const authEnabled = appState.settings.enable_device_id_auth;
        let optionsHtml = '<option value="">--填充--</option>';
        Object.entries(appState.devices).forEach(([did, info]) => { 
            let sec_ws_key = info.sec_ws_key || "";
            let max_sessions = typeof info.max_sessions !== "undefined" ? info.max_sessions : 1;
            optionsHtml += `<option value="${did}|${info.expiry}|${info.limit_gb}|${sec_ws_key}|${max_sessions}">${did}</option>`; 
        });
        let tableRowsHtml = '';
        Object.entries(appState.devices).sort((a, b) => a[0].localeCompare(b[0])).forEach(([did, info]) => {
            const limit = info.limit_gb > 0 ? `${info.limit_gb} GB` : '无限';
            const used = appState.usage[did] || 0;
            const sec_ws_key = info.sec_ws_key || "";
            const max_sessions = typeof info.max_sessions !== "undefined" ? info.max_sessions : 1;
            tableRowsHtml += `<tr id="device-row-${did}"><td>${did}</td><td><span style="font-size:12px;word-break:break-all;">${sec_ws_key}</span></td><td>${info.expiry}</td><td>${limit}</td><td class="used-traffic">${formatBytesJS(used)}</td><td>${max_sessions==0?"不限制":max_sessions}</td></tr>`;
        });
        contentArea.innerHTML = `<div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2 style="margin:0;">设备管理</h2>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <label class="toggle-switch"><input type="checkbox" id="device-auth-toggle" ${authEnabled ? 'checked' : ''} onchange="toggleDeviceAuth()"><span class="slider"></span></label>
                    <span id="device-auth-status-text">${authEnabled ? "Device ID 验证: 开启" : "已关闭 (全部放行)"}</span>
                </div>
            </div>
            <div class="form-row"><label>选择已有:</label><select id="existing_user" onchange="fillExisting()">${optionsHtml}</select></div>
            <div class="form-row">
                <label>ID:</label><input id="device_id" type="text">
                <label>Sec-WebSocket-Key:</label><input id="sec_ws_key" type="text" style="width:210px;"><button class="btn info" onclick="generateKey()">生成</button>
                <label>最大会话:</label><input id="max_sessions" type="number" value="1" style="width:60px;">
            </div>
            <div class="form-row">
                <label>有效期:</label><input id="expiry" type="text" placeholder="YYYY-MM-DD">
                <label>流量(GB):</label><input id="limit_gb" type="text" placeholder="0为无限">
                <button class="btn primary" onclick="addID()">保存</button><button class="btn danger" onclick="deleteID()">删除</button><button class="btn secondary" onclick="resetTraffic()">重置流量</button>
            </div>
            <div class="form-row"><label>自动生成(天):</label><input id="auto_expiry" type="text" value="${appState.settings.default_expiry_days}"><label>自动生成(GB):</label><input id="auto_limit" type="text" value="${appState.settings.default_limit_gb}"><button class="btn info" onclick="autoFill()">填充日期和流量</button></div>
        </div>
        <div class="card"><h3>当前列表</h3><div class="device-list-container"><table id="device-list"><thead><tr><th>ID</th><th>Sec-WebSocket-Key</th><th>有效期</th><th>流量限制</th><th>已用流量</th><th>最大会话</th></tr></thead><tbody>${tableRowsHtml}</tbody></table></div></div>`;
    }

    function renderAccountPage() { contentArea.innerHTML = `<div class="card"><h2>面板账号设置</h2><div class="form-row"><label>原账号:</label><input id="old_user" type="text" value="${appState.currentUser}"><label>原密码:</label><input id="old_pass" type="password"></div><div class="form-row"><label>新账号:</label><input id="new_user" type="text" value="${appState.currentUser}"><label>新密码:</label><input id="new_pass" type="password"><button class="btn secondary" onclick="updateAccount()">保存</button></div></div><div class="card"><h2>创建SSH隧道用户 (仅限本机登录)</h2><p style="font-size:13px;color:#64748b;">此功能会创建或更新一个系统用户，并修改 <b>/etc/ssh/sshd_config</b> 文件，以仅允许该用户从 127.0.0.1 (本机) 通过密码登录。主要用于 WSS payload 转发。请确保脚本以 root 权限运行。</p><div class="form-row"><label>SSH 用户名:</label><input id="ssh_user" type="text"><label>SSH 密码:</label><input id="ssh_pass" type="password"></div><div class="form-row" style="margin-top: 15px; gap: 15px;"><button class="btn secondary" onclick="manageSshUser('create')">创建/更新用户</button><button class="btn danger" onclick="manageSshUser('delete')">删除用户</button></div></div>`; }
    function renderSettingsPage() { const s = appState.settings; if (!s) { contentArea.innerHTML = `<div class="card">正在加载初始数据...</div>`; return; } const ip_whitelist_text = s.ip_whitelist ? s.ip_whitelist.join(',') : ''; const ip_blacklist_text = s.ip_blacklist ? s.ip_blacklist.join(',') : ''; contentArea.innerHTML = `<div class="card"><h2>系统设置</h2><div class="settings-grid"><div class="settings-group"><h3>服务器与端口</h3><div class="form-row"><label>WS端口 (http):</label><input id="s_http_port" type="text" value="${s.http_port}"></div><div class="form-row"><label>WSS端口 (tls):</label><input id="s_tls_port" type="text" value="${s.tls_port}"></div><div class="form-row"><label>管理后台端口:</label><input id="s_status_port" type="text" value="${s.status_port}"></div><div class="form-row full-width"><label>证书文件路径 (cert_file):</label><input id="s_cert_file" type="text" value="${s.cert_file}"></div><div class="form-row full-width"><label>密钥文件路径 (key_file):</label><input id="s_key_file" type="text" value="${s.key_file}"></div></div><div class="settings-group"><h3>连接与行为</h3><div class="form-row"><label>WS握手UA:</label><input id="s_ua_keyword_ws" type="text" value="${s.ua_keyword_ws}"></div><div class="form-row"><label>探测握手UA:</label><input id="s_ua_keyword_probe" type="text" value="${s.ua_keyword_probe}"></div><div class="form-row"><label>默认目标地址:</label><input id="s_default_target_host" type="text" value="${s.default_target_host}"></div><div class="form-row"><label>默认目标端口:</label><input id="s_default_target_port" type="text" value="${s.default_target_port}"></div><div class="form-row"><label>缓冲区(Bytes):</label><input id="s_buffer_size" type="text" value="${s.buffer_size}"></div><div class="form-row"><label>连接超时(秒):</label><input id="s_timeout" type="text" value="${s.timeout}"></div><div class="form-row" style="justify-content:space-between;padding-left:140px"><label style="min-width:auto;text-align:left;">允许同ID多点登录:</label><input id="s_allow_simultaneous_connections" type="checkbox" ${s.allow_simultaneous_connections ? 'checked' : ''}></div></div><div class="settings-group"><h3>用户与安全</h3><div class="form-row"><label>新设备默认有效期(天):</label><input id="s_default_expiry_days" type="text" value="${s.default_expiry_days}"></div><div class="form-row"><label>新设备默认流量(GB):</label><input id="s_default_limit_gb" type="text" value="${s.default_limit_gb}"></div><hr style="border:none; border-top:1px solid #f1f5f9; margin: 16px 0;"><div class="form-row" style="justify-content:space-between;padding-left:140px"><label style="min-width:auto;text-align:left;">启用IP白名单:</label><input id="s_enable_ip_whitelist" type="checkbox" ${s.enable_ip_whitelist ? 'checked' : ''}></div><div class="form-row full-width"><label>IP白名单列表 (逗号分隔):</label><input id="s_ip_whitelist" type="text" value="${ip_whitelist_text}"></div><div class="form-row" style="justify-content:space-between;padding-left:140px"><label style="min-width:auto;text-align:left;">启用IP黑名单:</label><input id="s_enable_ip_blacklist" type="checkbox" ${s.enable_ip_blacklist ? 'checked' : ''}></div><div class="form-row full-width"><label>IP黑名单列表 (逗号分隔):</label><input id="s_ip_blacklist" type="text" value="${ip_blacklist_text}"></div></div></div><div class="form-row" style="margin-top: 20px;"><button class="btn warning" onclick="saveSettings()">保存设置</button></div></div>`; }
    function renderLogsPage() { contentArea.innerHTML = `<div class="card"><h2>日志查看器(最新200条)</h2><div id="log-viewer" style="height:calc(100vh - 250px);overflow:auto;background:#282c34;color:#abb2bf;padding:10px;border-radius:8px;font-family:monospace;font-size:12px;white-space:pre-wrap;"></div></div>`; const v = gid('log-viewer'); if (!v) return; v.innerHTML = appState.logs.join('\n'); v.scrollTop = v.scrollHeight; }
    
    async function updateDynamicData() {
        const [statusData, connsData, usageData, logsData] = await Promise.all([ get('/api/server_status'), get("/api/connections"), get("/api/device_usage"), get("/api/logs") ]);
        if (statusData) {
            if(gid('cpu-usage')) gid('cpu-usage').textContent = (statusData.cpu_percent !== undefined) ? statusData.cpu_percent.toFixed(1) + '%' : '...';
            if(gid('cpu-cores')) gid('cpu-cores').textContent = statusData.cpu_cores || '...';
            if(gid('mem-usage') && statusData.mem_percent !== undefined) { const used_gb = statusData.mem_used / (1024**3); const total_gb = statusData.mem_total / (1024**3); gid('mem-usage').textContent = `${used_gb.toFixed(1)} / ${total_gb.toFixed(1)} GB (${statusData.mem_percent.toFixed(1)}%)`; } 
            if(gid('server-uptime')) gid('server-uptime').textContent = statusData.uptime || '...'; 
            if(gid('global-sent')) gid('global-sent').textContent = formatBytesJS(statusData.bytes_sent || 0); 
            if(gid('global-received')) gid('global-received').textContent = formatBytesJS(statusData.bytes_received || 0); 
        }
        if (connsData) { appState.connections = connsData; if(gid('active-connections')) gid('active-connections').textContent = connsData.filter(c => c.status === '活跃').length; }
        if (usageData) { appState.usage = usageData; }
        if (logsData) { appState.logs = logsData; }
        const path = window.location.hash || '#/status';
        if(path === '#/status') renderConnectionsTable();
        if(path === '#/device') { Object.entries(appState.usage).forEach(([did, usage]) => { const cell = document.querySelector(`#device-row-${did} .used-traffic`); if(cell) cell.textContent = formatBytesJS(usage); }); }
        if(path === '#/logs') { const v = gid('log-viewer'); if(v) { v.innerHTML = appState.logs.join('\n'); v.scrollTop = v.scrollHeight; } }
    }
    
    async function toggleDeviceAuth() { const toggle = gid('device-auth-toggle'); const statusText = gid('device-auth-status-text'); const isEnabled = toggle.checked; const originalText = statusText.textContent; statusText.textContent = "正在保存..."; toggle.disabled = true; const r = await post("/api/settings/toggle_device_auth", { enable: isEnabled }); if (r && r.status === 'ok') { alert(r.message); appState.settings.enable_device_id_auth = isEnabled; statusText.textContent = isEnabled ? "Device ID 验证: 开启" : "已关闭 (全部放行)"; } else { alert(r ? r.message : "操作失败"); toggle.checked = !isEnabled; statusText.textContent = originalText; } toggle.disabled = false; }
    
    function generateKey() { const array = new Uint8Array(16); window.crypto.getRandomValues(array); const b64 = btoa(String.fromCharCode.apply(null, array)); gid("sec_ws_key").value = b64; }
    async function addID() { const d = { device_id: gid("device_id").value.trim(), expiry: gid("expiry").value.trim(), limit_gb: gid("limit_gb").value.trim() || "0", sec_ws_key: gid("sec_ws_key").value.trim(), max_sessions: parseInt(gid("max_sessions").value, 10) || 1 }; if (!d.device_id || !d.expiry) return alert("ID和有效期不能为空"); if(!d.sec_ws_key) return alert("Sec-WebSocket-Key不能为空"); const r = await post("/device/add", d); if (r && r.status === 'ok') { alert(r.message); const [devs, usage] = await Promise.all([get('/api/devices'), get('/api/device_usage')]); appState.devices = devs || appState.devices; appState.usage = usage || appState.usage; renderDevicePage(); } }
    async function deleteID() { const id = gid("device_id").value.trim(); if (!id) return alert("ID不能为空"); if (confirm(`确定删除?`)) { const r = await post("/device/delete", { device_id: id }); if (r && r.status === "ok") { alert(r.message); const [devs, usage] = await Promise.all([get('/api/devices'), get('/api/device_usage')]); appState.devices = devs || appState.devices; appState.usage = usage || appState.usage; gid("device_id").value = ""; gid("expiry").value = ""; gid("limit_gb").value = ""; gid("sec_ws_key").value = ""; gid("max_sessions").value = "1"; renderDevicePage(); } } }
    async function resetTraffic() { const id = gid("device_id").value.trim(); if (!id) return alert("ID不能为空"); if (confirm(`确定重置流量?`)) { const r = await post("/device/reset_traffic", { device_id: id }); if (r && r.status === "ok") { alert(r.message); const usage = await get('/api/device_usage'); appState.usage = usage || appState.usage; renderDevicePage(); } } }
    function fillExisting() { const s = gid("existing_user"); if(!s.value) return; const [id, exp, lim, key, sessions] = s.value.split('|'); gid("device_id").value = id || ""; gid("expiry").value = exp || ""; gid("limit_gb").value = lim || ""; gid("sec_ws_key").value = key || ""; gid("max_sessions").value = sessions || "1"; }
    
    async function updateAccount() { const d = { old_user: gid("old_user").value, old_pass: gid("old_pass").value, new_user: gid("new_user").value, new_pass: gid("new_pass").value }; if (Object.values(d).some(v => !v)) return alert("请完整填写"); const r = await post("/account/update", d); if (r) { alert(r.message); if (r.status === 'ok') { logout(); } } }
    
    function logout() {
        post("/logout").finally(() => {
            window.location.href = "/";
        });
    }

    async function manageSshUser(action) { const user = gid('ssh_user').value.trim(); const pass = gid('ssh_pass').value.trim(); if (!user) return alert('SSH用户名不能为空'); if (action === 'create' && !pass) return alert('创建用户时密码不能为空'); const confirmText = action === 'create' ? `确定要创建或更新SSH用户 "${user}" 吗？\n这将修改系统用户和 sshd_config。` : `确定要删除SSH用户 "${user}" 吗？\n这将从系统中移除用户并清理 sshd_config。`; if (!confirm(confirmText)) return; const r = await post(`/api/ssh/${action}`, { username: user, password: pass }); if (r) { alert(r.message); if (r.status === 'ok') gid('ssh_pass').value = ''; } }
    async function kickUser(connKey, deviceId) { const displayName = deviceId || "此连接"; if (confirm(`确定要踢掉连接 ${displayName} (Key: ${connKey.slice(0,16)}...) 吗?`)) { const r = await post("/api/kick", { conn_key: connKey }); if (r) { alert(r.message); updateDynamicData(); } } }
    async function clearConnection(key) { if (!key) return; await post("/api/clear", { conn_key: key }); updateDynamicData(); }
    function filterTable() { const q = (gid("search_input")?.value || "").toLowerCase(); gid("connections-body")?.querySelectorAll("tr").forEach(r => { r.style.display = r.textContent.toLowerCase().includes(q) ? "" : "none"; }); }
    async function saveSettings() { const d = {}; document.querySelectorAll('[id^="s_"]').forEach(el => { let key = el.id.substring(2); let value = (el.type === 'checkbox') ? el.checked : el.value; const numberFields = ['http_port', 'tls_port', 'status_port', 'default_target_port', 'buffer_size', 'timeout', 'default_expiry_days', 'default_limit_gb']; if (numberFields.includes(key)) { value = parseInt(value, 10); } d[key] = value; }); if (confirm("确定要保存这些设置吗？\n\n注意：如果修改了任何端口号，服务将会自动重启。")) { const r = await post("/settings/save", d); if(r) alert(r.message); } }
    function autoFill() { const d = parseInt(gid('auto_expiry').value), t = new Date(); t.setDate(t.getDate() + d); gid('expiry').value = `${t.getFullYear()}-${('0' + (t.getMonth() + 1)).slice(-2)}-${('0' + t.getDate()).slice(-2)}`; gid('limit_gb').value = gid('auto_limit').value; }
    
    const routes = { '#/status': renderStatusPage, '#/device': renderDevicePage, '#/account': renderAccountPage, '#/settings': renderSettingsPage, '#/logs': renderLogsPage };
    
    function router() {
        // [修正] 从 router 中移除 clearInterval
        const path = window.location.hash || '#/status';
        const renderFunc = routes[path] || routes['#/status'];
        document.querySelectorAll('.navbar a').forEach(a => { a.classList.toggle('active', a.getAttribute('href') === path); });
        renderFunc();
    }
    
    async function initializeApp() {
        contentArea.innerHTML = `<div class="card">正在初始化应用...</div>`;
        
        const userMeta = document.querySelector('meta[name="user-context"]');
        if (userMeta) {
            appState.currentUser = userMeta.content;
        } else {
            appState.currentUser = "user";
        }
        gid('current-user').textContent = appState.currentUser;
        
        const [devices, usage, settings] = await Promise.all([get('/api/devices'), get('/api/device_usage'), get('/api/settings')]);
        appState.devices = devices || {}; 
        appState.usage = usage || {}; 
        appState.settings = settings;
        
        if (refreshInterval) clearInterval(refreshInterval); // 清理旧的定时器以防万一
        refreshInterval = setInterval(updateDynamicData, 3000);
        
        if (!window.location.hash) { window.location.hash = '#/status'; }
        
        router();
        updateDynamicData();
    }
    
    window.addEventListener('hashchange', router);
    document.addEventListener('DOMContentLoaded', initializeApp);
</script>
</body>
</html>
