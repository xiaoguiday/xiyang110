#!/bin/bash

# -------------------------------
# TCP Tweaker 一键运行版
# -------------------------------

# sysctl 配置文件路径
SYSCTL_FILE="/etc/sysctl.conf"

# TCP Tweaker 参数块
TCP_PARAMS="#PH56
net.ipv4.tcp_window_scaling = 1
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216
net.ipv4.tcp_rmem = 4096 87380 16777216
net.ipv4.tcp_wmem = 4096 16384 16777216
net.ipv4.tcp_low_latency = 1
net.ipv4.tcp_slow_start_after_idle = 0
net.core.default_qdisc = fq
net.ipv4.tcp_congestion_control = bbr"

# 彩色标题输出
tput setaf 7 ; tput setab 4 ; tput bold
printf '%35s%s%-20s\n' "TCP Tweaker 1.0 (Auto Apply)" 
tput sgr0
echo ""

# 检查是否已存在
if grep -q "^#PH56" "$SYSCTL_FILE"; then
    echo "TCP Tweaker settings already exist. Updating..."
    # 删除旧的 TCP Tweaker 设置
    grep -v "^#PH56" "$SYSCTL_FILE" | grep -v -F "net.ipv4.tcp_window_scaling" \
        | grep -v -F "net.core.rmem_max" \
        | grep -v -F "net.core.wmem_max" \
        | grep -v -F "net.ipv4.tcp_rmem" \
        | grep -v -F "net.ipv4.tcp_wmem" \
        | grep -v -F "net.ipv4.tcp_low_latency" \
        | grep -v -F "net.ipv4.tcp_slow_start_after_idle" \
        | grep -v -F "net.core.default_qdisc" \
        | grep -v -F "net.ipv4.tcp_congestion_control" > /tmp/sysctl.tmp
    mv /tmp/sysctl.tmp "$SYSCTL_FILE"
fi

# 添加新的 TCP Tweaker 设置
echo "" >> "$SYSCTL_FILE"
echo "$TCP_PARAMS" >> "$SYSCTL_FILE"

# 立即应用设置
sysctl -p "$SYSCTL_FILE" > /dev/null

echo ""
echo "✅ TCP Tweaker settings applied successfully!"
echo ""
exit 0
