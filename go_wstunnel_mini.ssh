#!/bin/bash

# =================================================================
# WSTunnel-Go å…¨è‡ªåŠ¨é™é»˜å®‰è£…/æ›´æ–°è„šæœ¬ (ç”Ÿäº§ç‰ˆ)
# ä½œè€…: xiaoguidays
# æ›´æ–°æ—¶é—´: 2025-10-15
# ç‰ˆæœ¬: 1.3
# æ›´æ–°å†…å®¹: å¢åŠ é™é»˜æ‰§è¡Œå’Œä¼˜åŒ–ç¼–è¯‘é€‰é¡¹ï¼Œå»é™¤ç¬¦å·è¡¨å’Œè°ƒè¯•ä¿¡æ¯ã€‚
# =================================================================

set -e # ä»»ä½•å‘½ä»¤å¤±è´¥ï¼Œè„šæœ¬ç«‹å³é€€å‡º

# --- è„šæœ¬è®¾ç½® ---
# é¢œè‰²ä»£ç 
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m'

# é¡¹ç›®é…ç½®
GO_VERSION="1.22.3"
PROJECT_DIR="/usr/local/src/go_wstunnel"
GITHUB_REPO="xiaoguiday/xiyang110"
SERVICE_NAME="wstunnel"
BINARY_NAME="wstunnel-go"
DEPLOY_DIR="/usr/local/bin/wstunnel"

# --- å‡½æ•°å®šä¹‰ ---
info() { echo -e "${GREEN}[INFO] $1${NC}"; }
error_exit() { echo -e "${RED}[ERROR] $1${NC}"; exit 1; }

# --- è„šæœ¬ä¸»é€»è¾‘ ---

# 1. æƒé™æ£€æŸ¥
info "Step 1: Checking for root privileges..."
if [ "$(id -u)" != "0" ]; then
   error_exit "This script must be run as root. Please use 'sudo' or run as the root user."
fi

# 2. å®‰è£…å¿…è¦çš„å·¥å…· (é™é»˜æ¨¡å¼)
info "Step 2: Installing required tools (wget, curl, tar, git)..."
apt-get update -y > /dev/null 2>&1
apt-get install -y wget curl tar git > /dev/null 2>&1 || error_exit "Failed to install required tools!"

# 3. å®‰è£… Go è¯­è¨€ç¯å¢ƒ (é™é»˜æ¨¡å¼)
info "Step 3: Checking and installing Go environment..."
if ! command -v go &> /dev/null || [[ ! $(go version) == *"go${GO_VERSION}"* ]]; then
    info "Go environment not found or version mismatch. Installing Go ${GO_VERSION}..."
    wget -q -O go.tar.gz "https://go.dev/dl/go${GO_VERSION}.linux-amd64.tar.gz" || error_exit "Failed to download Go package!"
    rm -rf /usr/local/go && tar -C /usr/local -xzf go.tar.gz > /dev/null 2>&1 || error_exit "Failed to extract Go package!"
    rm go.tar.gz

    if ! grep -q "/usr/local/go/bin" /etc/profile; then
        echo 'export PATH=$PATH:/usr/local/go/bin' >> /etc/profile
    fi
    export PATH=$PATH:/usr/local/go/bin
fi
if ! command -v go &> /dev/null; then
    error_exit "Go command is not available. Try running 'source /etc/profile' and re-run the script."
fi

# 4. åˆ›å»ºé¡¹ç›®ç›®å½•å¹¶æ‹‰å–æ–‡ä»¶ (é™é»˜æ¨¡å¼)
info "Step 4: Preparing project directory and fetching source code..."
mkdir -p "$PROJECT_DIR"
cd "$PROJECT_DIR" || error_exit "Failed to enter project directory '$PROJECT_DIR'!"

wget -q -O main.go "https://raw.githubusercontent.com/${GITHUB_REPO}/main/main.go" || error_exit "Failed to download main.go!"
wget -q -O admin.html "https://raw.githubusercontent.com/${GITHUB_REPO}/main/admin.html" || error_exit "Failed to download admin.html!"
wget -q -O login.html "https://raw.githubusercontent.com/${GITHUB_REPO}/main/login.html" || error_exit "Failed to download login.html!"

# 5. ç¼–è¯‘é¡¹ç›® (ä¼˜åŒ–ç¼–è¯‘é€‰é¡¹)
info "Step 5: Compiling the project with optimizations..."
if [ ! -f "go.mod" ]; then
    go mod init wstunnel > /dev/null 2>&1 || error_exit "go mod init failed!"
fi
go mod tidy > /dev/null 2>&1 || error_exit "go mod tidy failed!"

# --- [æ ¸å¿ƒæ”¹åŠ¨] ---
# ä½¿ç”¨ -ldflags "-s -w" æ¥å»é™¤ç¬¦å·è¡¨å’Œè°ƒè¯•ä¿¡æ¯
go build -ldflags "-s -w" -o ${BINARY_NAME} || error_exit "Compilation failed!"
info "Project compiled successfully."

# 6. éƒ¨ç½²æ–‡ä»¶
info "Step 6: Deploying files to ${DEPLOY_DIR}/ ..."
mv ./${BINARY_NAME} ${DEPLOY_DIR}/ || error_exit "Failed to move ${BINARY_NAME}!"
mv ./admin.html ${DEPLOY_DIR}/ || error_exit "Failed to move admin.html!"
mv ./login.html ${DEPLOY_DIR}/ || error_exit "Failed to move login.html!"

# 7. åˆ›å»ºå¹¶å¯ç”¨ systemd æœåŠ¡
SERVICE_FILE="/etc/systemd/system/${SERVICE_NAME}.service"
info "Step 7: Configuring systemd service..."
cat > "$SERVICE_FILE" <<EOT
[Unit]
Description=WSTunnel-Go Service
After=network.target

[Service]
Type=simple
User=root
Group=root
WorkingDirectory=${DEPLOY_DIR}
ExecStart=${DEPLOY_DIR}/${BINARY_NAME}
Restart=always
RestartSec=3
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOT

systemctl daemon-reload || error_exit "systemctl daemon-reload failed!"
systemctl enable ${SERVICE_NAME}.service > /dev/null 2>&1 || error_exit "systemctl enable failed!"

# 8. å¯åŠ¨/é‡å¯æœåŠ¡å¹¶æ£€æŸ¥çŠ¶æ€
info "Step 8: Starting/Restarting the service..."
systemctl restart ${SERVICE_NAME}.service || error_exit "Service start/restart failed!"
info "Operation successful."
echo " "

# æœ€ç»ˆç¡®è®¤
info "ğŸ‰ Success! WSTunnel-Go has been installed/updated and is running."
info "Checking final service status (waiting 2 seconds)..."
sleep 2
systemctl status ${SERVICE_NAME}.service --no-pager
